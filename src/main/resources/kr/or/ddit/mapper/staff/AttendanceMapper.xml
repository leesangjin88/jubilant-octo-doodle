<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.pfcp.staff.lecturemanage.attendance.mapper.AttendanceMapper">


<resultMap id="attendanceResultMap" type="kr.or.ddit.pfcp.common.vo.AttendanceVO" autoMapping="true">
    <id property="attendId" column="ATTEND_ID"/>

    <association property="lectureEnr" javaType="kr.or.ddit.pfcp.common.vo.LectureEnrVO" autoMapping="true">
        <id property="enrollNo" column="ENROLL_ENR"/>
    </association>
    
    <association property="user" javaType="kr.or.ddit.pfcp.common.vo.UserVO" autoMapping="true">
        <id property="userNo" column="USER_NO"/>
        <result property="userName" column="USER_NAME"/>
    </association>
    
    <association property="student" javaType="kr.or.ddit.pfcp.common.vo.StudentVO" autoMapping="true">
        <id property="userNo" column="USER_NO"/>
    </association>

    <association property="lecture" javaType="kr.or.ddit.pfcp.common.vo.LectureVO" autoMapping="true">
        <id property="lecNo" column="SUBJECT_CODE"/>
    </association>
    
    <association property="lectureReq" javaType="kr.or.ddit.pfcp.common.vo.LectureReqVO" autoMapping="true">
        <id property="reqNo" column="REQ_NO"/>
        <result property="lecName" column="LEC_NAME"/>
    </association>
</resultMap>

	<update id="updateAttendanceList" parameterType="kr.or.ddit.pfcp.common.vo.AttendanceVO">
		
	</update>

	<select id="selectAttendanceList" resultMap="attendanceResultMap">
			SELECT
				ROW_NUMBER() OVER (ORDER BY A.ATTEND_ID) AS RNUM,
			    A.ATTEND_ID,
			    A.ENROLL_NO,
			    A.ATTEND_DATE,
			    A.ATTEND_STATUS,
			    A.MEMO,
			    A.WEEK,
			    TU.USER_NAME,
			    LR.LEC_NAME
			FROM
			    ATTENDANCE A
			JOIN
			    LECTURE_ENR LE ON A.ENROLL_NO = LE.ENROLL_NO
			JOIN
			    TB_USER TU ON LE.USER_NO = TU.USER_NO
			JOIN
			    STUDENT S ON TU.USER_NO = S.USER_NO -- TB_USER와 STUDENT 테이블 연결 (USER_NO를 키로 사용)
			JOIN
			    LECTURE L ON LE.LEC_NO = L.LEC_NO
			JOIN
			    LECTURE_REQ LR ON L.REQ_NO = LR.REQ_NO 
			WHERE
			    LE.ENROLL_NO = #{enrNo} AND LE.USER_NO = #{userNo}
	</select>

	<select id="selectAttendanceById" resultType="kr.or.ddit.pfcp.common.vo.AttendanceVO">
	    SELECT ATTEND_ID, ATTEND_STATUS, MEMO
	    FROM ATTENDANCE
	    WHERE ATTEND_ID = #{attendId}
	</select>
	
	<update id="updateAttendance">
	    UPDATE ATTENDANCE
	    SET ATTEND_STATUS = #{attendStatus},
	        MEMO = #{memo}
	    WHERE ATTEND_ID = #{attendId}
	</update>
	

</mapper>