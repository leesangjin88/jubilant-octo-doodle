<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.pfcp.student.lecture.evaluate.mapper.LectureEvaluationMapper">
	<resultMap id="lectureEnrMap" type="kr.or.ddit.pfcp.common.vo.LectureEnrVO">
	    <id property="enrollNo" column="ENROLL_NO"/>
	    <result property="lecNo" column="LEC_NO"/>
	    <result property="userNo" column="USER_NO"/>
	    <result property="enrollTime" column="ENROLL_TIME"/>
	    <result property="enrollStatus" column="ENROLL_STATUS"/>
	    <result property="enrollType" column="ENROLL_TYPE"/>
	    <result property="priority" column="PRIORITY"/>
	    <result property="attendance" column="ATTENDANCE"/>
	    <result property="evalYn" column="EVAL_YN"/>
	
	    <!-- SubjectVO 매핑 -->
	    <association property="subject" javaType="kr.or.ddit.pfcp.common.vo.SubjectVO">
	        <result property="subjectCode" column="SUBJECT_CODE"/>
	        <result property="subjectName" column="SUBJECT_NAME"/>
	    </association>
	</resultMap>
	
	<select id="selectLectureEnr" resultMap="lectureEnrMap">
		SELECT A.ENROLL_NO
           	   , A.LEC_NO
           	   , A.USER_NO
           	   , A.ENROLL_TIME
               , A.ENROLL_STATUS
               , A.ENROLL_TYPE
          	   , A.PRIORITY
           	   , A.ATTENDANCE
           	   , A.EVAL_YN
           	   , D.SUBJECT_CODE
           	   , D.SUBJECT_NAME
      	  FROM LECTURE_ENR A
	INNER JOIN LECTURE B ON A.LEC_NO=B.LEC_NO
	INNER JOIN LECTURE_REQ C ON C.REQ_NO=B.REQ_NO
	INNER JOIN SUBJECT D ON C.SUBJECT_CODE=D.SUBJECT_CODE
     	 WHERE A.USER_NO=#{userNo}
	</select>

	<select id="selectLectureEvaluationList">
		SELECT CRITERIA_NO
		       , CRITERIA_NAME
		       , COLUMN_ALIAS
		       , CRITERIA_DESC
		       , CRITERIA_USE
		       , USE_FOR
		  FROM EVAL_CRITERIA
		 WHERE USE_FOR='강의평가'
	</select>

	<insert id="insertLectureEvalScore">
		INSERT INTO LECTURE_EVAL_SCORE (
			EVAL_SCORE
			, EVAL_NO
			, CRITERIA_NO
		)
		VALUES (
			#{evalScore}
			, #{evalNo}
			, #{criteriaNo}
		)
	</insert>
	
	<insert id="insertLectureEval">
		INSERT INTO LECTURE_EVAL (
			EVAL_NO
			, ENROLL_NO
			, EVAL_DATE
			, OVERALL_SCORE
			, EVAL_COMMENT
		) 
		VALUES (
			#{evalNo}
			, #{enrollNo}
			, TO_CHAR(SYSDATE, 'YYYY-MM-DD')
			, #{overallScore}
			, #{comment}
		)
	</insert>
	
	<update id="updateLectureEnrEvalYN">
		UPDATE LECTURE_ENR
		   SET EVAL_YN='Y'
		 WHERE USER_NO=#{userNo}
	</update>
	
	<select id="existsEvalByEnrollNo" resultType="boolean">
		 SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
		   FROM LECTURE_EVAL
		  WHERE ENROLL_NO = #{enrollNo}
	</select>
</mapper>